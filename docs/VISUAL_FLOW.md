# Visual Flow: Sub-Game Launch Feature

## User Journey

### Scenario A: Player NOT on aeroWreckage

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [Game Board]                           â”‚
â”‚                                         â”‚
â”‚         ðŸ§ Christos (player)            â”‚
â”‚                                         â”‚
â”‚                                         â”‚
â”‚              âœˆï¸  aeroWreckage           â”‚
â”‚                                         â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ Player taps object
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—          â”‚
â”‚         â•‘  Aero-Wreckage    â•‘          â”‚
â”‚         â•‘                   â•‘          â”‚
â”‚         â•‘  [Image of wreck] â•‘          â”‚
â”‚         â•‘                   â•‘          â”‚
â”‚         â•‘  The twisted      â•‘          â”‚
â”‚         â•‘  remnants of a    â•‘          â”‚
â”‚         â•‘  long-lost...     â•‘          â”‚
â”‚         â•‘                   â•‘          â”‚
â”‚         â•‘      [X Close]    â•‘          â”‚
â”‚         â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                NO CTA BUTTON
```

### Scenario B: Player ON aeroWreckage

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [Game Board]                           â”‚
â”‚                                         â”‚
â”‚                                         â”‚
â”‚              âœˆï¸  aeroWreckage           â”‚
â”‚              ðŸ§ Christos                â”‚
â”‚                                         â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ Player taps object
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—          â”‚
â”‚         â•‘  Aero-Wreckage    â•‘          â”‚
â”‚         â•‘                   â•‘          â”‚
â”‚         â•‘  [Image of wreck] â•‘          â”‚
â”‚         â•‘                   â•‘          â”‚
â”‚         â•‘  The twisted      â•‘          â”‚
â”‚         â•‘  remnants of a    â•‘          â”‚
â”‚         â•‘  long-lost...     â•‘          â”‚
â”‚         â•‘                   â•‘          â”‚
â”‚         â•‘ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘          â”‚
â”‚         â•‘ â”‚ Investigate   â”‚ â•‘ â† CTA!   â”‚
â”‚         â•‘ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘          â”‚
â”‚         â•‘      [X Close]    â•‘          â”‚
â”‚         â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ Player taps "Investigate"
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [Sub-Game Screen]                      â”‚
â”‚                                         â”‚
â”‚     Aero-Wreckage Puzzle                â”‚
â”‚                                         â”‚
â”‚  You investigate the ancient            â”‚
â”‚  aerocraft wreckage. Strange            â”‚
â”‚  devices and mysterious                 â”‚
â”‚  mechanisms lie before you.             â”‚
â”‚                                         â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚         â”‚    I Win      â”‚               â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ Player taps "I Win"
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [Game Board - Returned]                â”‚
â”‚                                         â”‚
â”‚                                         â”‚
â”‚              âœˆï¸  aeroWreckage           â”‚
â”‚              ðŸ§ Christos                â”‚
â”‚         (same position!)                â”‚
â”‚                                         â”‚
â”‚  GameState updated:                     â”‚
â”‚  subGamesCompleted.aerowreckagePuzzle   â”‚
â”‚  = true                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## State Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    GameContext                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  GameState {                                        â”‚  â”‚
â”‚  â”‚    player: { position: {row, col}, hp, ... }        â”‚  â”‚
â”‚  â”‚    level: { ... }                                   â”‚  â”‚
â”‚  â”‚    subGamesCompleted: {                             â”‚  â”‚
â”‚  â”‚      aerowreckagePuzzle: false â†’ true               â”‚  â”‚
â”‚  â”‚    }                                                 â”‚  â”‚
â”‚  â”‚  }                                                   â”‚  â”‚
â”‚  â”‚                                                      â”‚  â”‚
â”‚  â”‚  rpgResumeNonce: 0 â†’ 1 â†’ 2 â†’ ...                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†‘                                      â†‘
         â”‚ useGameContext()                    â”‚ useGameContext()
         â”‚                                      â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  RPG Screen â”‚ â†â”€â”€â”€â”€ router.back() â”€â”‚  Sub-Game      â”‚
    â”‚  (game/)    â”‚                      â”‚  Screen        â”‚
    â”‚             â”‚ â”€â”€â”€â”€ router.push() â”€â†’â”‚  (sub-games/)  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                      â”‚
         â”‚ handleBuildingTap():                 â”‚ handleWin():
         â”‚ - Check player position              â”‚ - dispatch(action)
         â”‚ - Check object.subGame               â”‚ - signalRpgResume()
         â”‚ - Gate CTA visibility                â”‚ - exitSubGame()
         â”‚ - enterSubGame()                     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Code Flow

### 1. Player Taps Building

```typescript
// GameBoard.tsx - handleBuildingTap()
const launch = building.subGame // from config
const playerOnObject = isPlayerOnObject(
  state.player.position,
  building.position,
  building.width,
  building.height
)
const canLaunch = launch && playerOnObject

if (canLaunch) {
  showInfo(
    building.name,
    building.description,
    building.image,
    launch.ctaLabel, // "Investigate"
    () => {
      setInfoVisible(false)
      enterSubGame(launch.subGameName) // "aerowreckage-puzzle"
    }
  )
}
```

### 2. InfoBox Renders

```typescript
// InfoBox.tsx
<Text style={styles.description}>{description}</Text>

{ctaLabel && onCtaPress && (
  <TouchableOpacity onPress={onCtaPress}>
    <Text>{ctaLabel}</Text>
  </TouchableOpacity>
)}
```

### 3. Navigation to Sub-Game

```typescript
// lib/subGames.ts
export function enterSubGame(subGameName: string) {
  router.push(`/sub-games/${subGameName}`)
  // Routes to: app/sub-games/aerowreckage-puzzle/index.tsx
}
```

### 4. Sub-Game Completion

```typescript
// app/sub-games/aerowreckage-puzzle/index.tsx
const handleWin = () => {
  dispatch({
    type: 'SET_SUB_GAME_COMPLETED',
    payload: { subGameName: 'aerowreckagePuzzle', completed: true },
  })
  signalRpgResume() // Increment nonce
  exitSubGame({ completed: true })
}
```

### 5. Return to RPG

```typescript
// lib/subGames.ts
export function exitSubGame(result?: SubGameResult) {
  router.back() // Return to previous screen (RPG)
}

// GameContext maintains state across navigation
// RPG screen can watch rpgResumeNonce to trigger refresh
```

## Data Flow Summary

1. **Config** â†’ Object defines sub-game metadata
2. **Tap** â†’ GameBoard checks player position
3. **Gate** â†’ CTA only shown if player on object
4. **Navigate** â†’ Router pushes to sub-game screen
5. **Access** â†’ Sub-game reads/writes GameContext
6. **Complete** â†’ Sub-game dispatches action, signals resume
7. **Return** â†’ Router pops back to RPG
8. **Refresh** â†’ RPG watches nonce, refreshes board
9. **Preserve** â†’ GameContext state survives navigation

## Key Design Principles

âœ… **Config-Driven**: Object config is single source of truth  
âœ… **Presentational UI**: InfoBox has no business logic  
âœ… **Position-Based**: Player must be at object to interact  
âœ… **State Preservation**: Navigation doesn't reset game state  
âœ… **Scalable**: Adding new sub-games requires minimal code
